openapi: 3.1.0
info:
  title: Yantra4D API
  version: 1.0.0
  description: |
    REST API for the Yantra4D parametric 3D design platform.
    Provides OpenSCAD rendering, project management, AI-assisted design,
    Git operations, and analytics.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:5000
    description: Local development
  - url: https://api.yantra4d.com
    description: Production

tags:
  - name: health
    description: Service health and readiness
  - name: projects
    description: Project listing, manifests, forking, and static assets
  - name: manifest
    description: Legacy single-project manifest endpoints
  - name: render
    description: OpenSCAD rendering (sync, streaming, estimate, cancel)
  - name: download
    description: Auth-gated file downloads (STL, SCAD)
  - name: editor
    description: In-browser SCAD file editor CRUD
  - name: git
    description: Git operations (status, diff, commit, push, pull)
  - name: github
    description: GitHub repository import and sync
  - name: ai
    description: AI-assisted design (session management, chat streaming)
  - name: bom
    description: Bill of materials generation
  - name: datasheet
    description: PDF/HTML datasheet generation
  - name: analytics
    description: Usage tracking and project analytics
  - name: user
    description: User info and tier management
  - name: onboard
    description: New project creation wizard
  - name: admin
    description: Administrative project management

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Janua-issued JWT token

  schemas:
    Error:
      type: object
      properties:
        status:
          type: string
          example: error
        error:
          type: string
      required: [status, error]

    ProjectSummary:
      type: object
      properties:
        slug:
          type: string
          example: gridfinity
        name:
          type: string
          example: Gridfinity Bin
        description:
          type: object
          properties:
            en:
              type: string
            es:
              type: string
        thumbnail:
          type: string
        tags:
          type: array
          items:
            type: string
        difficulty:
          type: string
          enum: [beginner, intermediate, advanced]
        stats:
          type: object
          description: Only present when ?stats=1
          properties:
            renders:
              type: integer
            exports:
              type: integer
            preset_applies:
              type: integer

    Manifest:
      type: object
      properties:
        project:
          type: object
          properties:
            name:
              type: string
            slug:
              type: string
            version:
              type: string
            description:
              type: object
            thumbnail:
              type: string
            tags:
              type: array
              items:
                type: string
            difficulty:
              type: string
        modes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              scad_file:
                type: string
              label:
                type: object
              parts:
                type: array
                items:
                  type: string
              estimate:
                type: object
        parts:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              render_mode:
                type: integer
              label:
                type: object
              default_color:
                type: string
        parameters:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              type:
                type: string
              default:
                oneOf:
                  - type: number
                  - type: string
                  - type: boolean
              min:
                type: number
              max:
                type: number
              step:
                type: number
              label:
                type: object
              visible_in_modes:
                type: array
                items:
                  type: string
        estimate_constants:
          type: object
          properties:
            base_time:
              type: number
            per_unit:
              type: number
            per_part:
              type: number
        presets:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              label:
                type: object
              values:
                type: object
      required: [project, modes, parts, parameters, estimate_constants]

    RenderRequest:
      type: object
      properties:
        project:
          type: string
          description: Project slug
        mode:
          type: string
          description: Mode ID from manifest
        scad_file:
          type: string
          description: Deprecated — use mode instead
        parameters:
          type: object
          additionalProperties: true
        export_format:
          type: string
          enum: [stl, 3mf, off]
          default: stl
      required: [mode]

    RenderResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        parts:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              url:
                type: string
                format: uri
              size_bytes:
                type: integer
        log:
          type: string

    EstimateRequest:
      type: object
      properties:
        project:
          type: string
        mode:
          type: string
        scad_file:
          type: string
        parameters:
          type: object

    EstimateResponse:
      type: object
      properties:
        estimated_seconds:
          type: number
        num_parts:
          type: integer
        num_units:
          type: number

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
        openscad_available:
          type: boolean
        debug_mode:
          type: boolean
      required: [status, openscad_available]

paths:
  # ── Health ──────────────────────────────────────────────
  /api/health:
    get:
      tags: [health]
      summary: Health check
      description: Returns service status and OpenSCAD availability.
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  # ── Projects ────────────────────────────────────────────
  /api/projects:
    get:
      tags: [projects]
      summary: List all projects
      operationId: listProjects
      parameters:
        - name: stats
          in: query
          schema:
            type: string
            enum: ["1"]
          description: Include 30-day analytics stats
      responses:
        "200":
          description: Array of project summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ProjectSummary"

  /api/projects/{slug}/manifest:
    get:
      tags: [projects]
      summary: Get project manifest
      operationId: getProjectManifest
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Full project manifest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Manifest"
        "304":
          description: Not modified (ETag match)
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/projects/{slug}/meta:
    get:
      tags: [projects]
      summary: Get project metadata
      operationId: getProjectMeta
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Project metadata or null
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                  - type: "null"

  /api/projects/{slug}/parts/{filename}:
    get:
      tags: [projects]
      summary: Serve static part file
      operationId: serveStaticPart
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Binary STL file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "403":
          description: Path traversal blocked
        "404":
          description: File or project not found

  /api/projects/{slug}/fork:
    post:
      tags: [projects]
      summary: Fork a project
      operationId: forkProject
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                new_slug:
                  type: string
                  pattern: "^[a-z0-9][a-z0-9_-]{1,48}[a-z0-9]$"
              required: [new_slug]
      responses:
        "200":
          description: Fork successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  slug:
                    type: string
        "400":
          description: Invalid slug
        "401":
          description: Pro tier required
        "409":
          description: Slug already exists

  /api/projects/{slug}/manifest/assembly-steps:
    put:
      tags: [projects]
      summary: Update assembly steps
      operationId: updateAssemblySteps
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                assembly_steps:
                  type: array
                  items:
                    type: object
              required: [assembly_steps]
      responses:
        "200":
          description: Steps saved
        "400":
          description: Missing assembly_steps
        "404":
          description: Project not found

  # ── Legacy Manifest ────────────────────────────────────
  /api/manifest:
    get:
      tags: [manifest]
      summary: Get default manifest (legacy)
      operationId: getManifest
      deprecated: true
      responses:
        "200":
          description: Default project manifest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Manifest"

  /api/config:
    get:
      tags: [manifest]
      summary: Get config (legacy, delegates to manifest)
      operationId: getConfig
      deprecated: true
      responses:
        "200":
          description: Legacy config response
          content:
            application/json:
              schema:
                type: object

  # ── Render ──────────────────────────────────────────────
  /api/estimate:
    post:
      tags: [render]
      summary: Estimate render time
      operationId: estimateRenderTime
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EstimateRequest"
      responses:
        "200":
          description: Time estimate
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EstimateResponse"

  /api/render:
    post:
      tags: [render]
      summary: Synchronous render
      operationId: renderStl
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RenderRequest"
      responses:
        "200":
          description: Render complete
          headers:
            X-RateLimit-Limit:
              schema:
                type: string
            X-RateLimit-Tier:
              schema:
                type: string
            X-Cache:
              schema:
                type: string
                enum: [HIT, MISS]
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RenderResponse"
        "400":
          description: Invalid mode or SCAD file
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/render-stream:
    post:
      tags: [render]
      summary: Stream render via SSE
      operationId: renderStlStream
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RenderRequest"
      responses:
        "200":
          description: Server-Sent Events stream
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSE events: progress, part_done, complete.
                  Each `data:` line is a JSON object with an `event` field.

  /api/render-cancel:
    post:
      tags: [render]
      summary: Cancel active render
      operationId: cancelRender
      responses:
        "200":
          description: Cancel result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [cancelled, no_active_render]
                  cancelled:
                    type: boolean

  # ── Download ────────────────────────────────────────────
  /api/projects/{slug}/download/stl/{filename}:
    get:
      tags: [download]
      summary: Download STL file
      operationId: downloadStl
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: STL binary
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          description: Authentication required
        "404":
          description: File not found

  /api/projects/{slug}/download/scad/{filename}:
    get:
      tags: [download]
      summary: Download SCAD source file
      operationId: downloadScad
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: SCAD source file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "403":
          description: File not in manifest allowlist
        "404":
          description: File not found

  # ── Editor ──────────────────────────────────────────────
  /api/projects/{slug}/files:
    get:
      tags: [editor]
      summary: List project files
      operationId: listFiles
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: File listing
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: string
    post:
      tags: [editor]
      summary: Create a new file
      operationId: createFile
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filepath:
                  type: string
                content:
                  type: string
              required: [filepath]
      responses:
        "201":
          description: File created
        "400":
          description: Invalid path
        "409":
          description: File already exists

  /api/projects/{slug}/files/{filepath}:
    get:
      tags: [editor]
      summary: Read file content
      operationId: readFile
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filepath
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: File content
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
        "404":
          description: File not found
    put:
      tags: [editor]
      summary: Write file content
      operationId: writeFile
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filepath
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
              required: [content]
      responses:
        "200":
          description: File written
        "400":
          description: Invalid path
    delete:
      tags: [editor]
      summary: Delete a file
      operationId: deleteFile
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: filepath
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: File deleted
        "404":
          description: File not found

  # ── Git ─────────────────────────────────────────────────
  /api/projects/{slug}/git/connect-remote:
    post:
      tags: [git]
      summary: Connect a Git remote
      operationId: connectRemote
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repo_url:
                  type: string
                  format: uri
              required: [repo_url]
      responses:
        "200":
          description: Remote connected
        "400":
          description: Invalid repository URL

  /api/projects/{slug}/git/status:
    get:
      tags: [git]
      summary: Get Git status
      operationId: getGitStatus
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Git status
          content:
            application/json:
              schema:
                type: object
                properties:
                  initialized:
                    type: boolean
                  branch:
                    type: string
                  clean:
                    type: boolean
                  changed_files:
                    type: array
                    items:
                      type: string
                  remote:
                    type: string

  /api/projects/{slug}/git/diff:
    get:
      tags: [git]
      summary: Get Git diff
      operationId: getGitDiff
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Diff output
          content:
            application/json:
              schema:
                type: object
                properties:
                  diff:
                    type: string

  /api/projects/{slug}/git/commit:
    post:
      tags: [git]
      summary: Create a Git commit
      operationId: gitCommit
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
              required: [message]
      responses:
        "200":
          description: Commit created
        "400":
          description: Missing message or nothing to commit

  /api/projects/{slug}/git/push:
    post:
      tags: [git]
      summary: Push to remote
      operationId: gitPush
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Pushed successfully
        "400":
          description: No remote configured

  /api/projects/{slug}/git/pull:
    post:
      tags: [git]
      summary: Pull from remote
      operationId: gitPull
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Pulled successfully
        "400":
          description: No remote configured

  # ── GitHub ──────────────────────────────────────────────
  /api/github/validate:
    post:
      tags: [github]
      summary: Validate a GitHub repository URL
      operationId: githubValidate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repo_url:
                  type: string
                  format: uri
              required: [repo_url]
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  repo_name:
                    type: string
                  has_scad_files:
                    type: boolean

  /api/github/import:
    post:
      tags: [github]
      summary: Import a GitHub repository as a project
      operationId: githubImport
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repo_url:
                  type: string
                slug:
                  type: string
              required: [repo_url]
      responses:
        "200":
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  slug:
                    type: string

  /api/github/sync:
    post:
      tags: [github]
      summary: Sync a GitHub-imported project
      operationId: githubSync
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                slug:
                  type: string
              required: [slug]
      responses:
        "200":
          description: Sync result

  # ── AI ──────────────────────────────────────────────────
  /api/ai/session:
    post:
      tags: [ai]
      summary: Create an AI session
      operationId: createAiSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                project:
                  type: string
                mode:
                  type: string
              required: [project]
      responses:
        "200":
          description: Session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string

  /api/ai/chat-stream:
    post:
      tags: [ai]
      summary: Stream AI chat responses
      operationId: aiChatStream
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                session_id:
                  type: string
                message:
                  type: string
                project:
                  type: string
              required: [session_id, message]
      responses:
        "200":
          description: Server-Sent Events stream
          content:
            text/event-stream:
              schema:
                type: string

  # ── BOM ─────────────────────────────────────────────────
  /api/projects/{slug}/bom:
    get:
      tags: [bom]
      summary: Get bill of materials
      operationId: getBom
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: BOM data
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
        "404":
          description: Project not found

  # ── Datasheet ───────────────────────────────────────────
  /api/projects/{slug}/datasheet:
    get:
      tags: [datasheet]
      summary: Generate project datasheet
      operationId: generateDatasheet
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum: [pdf, html]
            default: pdf
        - name: lang
          in: query
          schema:
            type: string
            default: en
      responses:
        "200":
          description: Datasheet document
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            text/html:
              schema:
                type: string
        "404":
          description: Project not found

  # ── Analytics ───────────────────────────────────────────
  /api/analytics/track:
    post:
      tags: [analytics]
      summary: Track a usage event
      operationId: trackEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                project:
                  type: string
                event_type:
                  type: string
                  enum: [render, export, preset_apply, page_view, share]
                metadata:
                  type: object
              required: [project, event_type]
      responses:
        "201":
          description: Event tracked

  /api/analytics/{slug}/summary:
    get:
      tags: [analytics]
      summary: Get analytics summary
      operationId: getAnalyticsSummary
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Analytics summary
          content:
            application/json:
              schema:
                type: object

  # ── User ────────────────────────────────────────────────
  /api/tiers:
    get:
      tags: [user]
      summary: Get available tiers
      operationId: getTiers
      responses:
        "200":
          description: Tier definitions
          content:
            application/json:
              schema:
                type: object

  /api/me:
    get:
      tags: [user]
      summary: Get current user info
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile and tier
          content:
            application/json:
              schema:
                type: object
                properties:
                  tier:
                    type: string
                  sub:
                    type: string

  # ── Onboard ─────────────────────────────────────────────
  /api/projects/analyze:
    post:
      tags: [onboard]
      summary: Analyze uploaded SCAD files
      operationId: analyzeProject
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        "200":
          description: Analysis result with suggested manifest
          content:
            application/json:
              schema:
                type: object
                properties:
                  parameters:
                    type: array
                    items:
                      type: object
                  modules:
                    type: array
                    items:
                      type: string
                  warnings:
                    type: array
                    items:
                      type: string

  /api/projects/create:
    post:
      tags: [onboard]
      summary: Create a new project
      operationId: createProject
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                manifest:
                  type: string
                  description: JSON manifest string
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        "200":
          description: Project created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  slug:
                    type: string

  # ── Admin ───────────────────────────────────────────────
  /api/admin/projects:
    get:
      tags: [admin]
      summary: List all projects (admin)
      operationId: adminListProjects
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Enriched project list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/admin/projects/{slug}:
    get:
      tags: [admin]
      summary: Get project details (admin)
      operationId: adminProjectDetail
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Detailed project info
        "404":
          description: Project not found

  # ── Verify ──────────────────────────────────────────────
  /api/verify:
    post:
      tags: [render]
      summary: Run verification suite
      operationId: verifyDesign
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                project:
                  type: string
                mode:
                  type: string
                parts:
                  type: array
                  items:
                    type: object
      responses:
        "200":
          description: Verification results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [passed, failed]
                  passed:
                    type: boolean
                  output:
                    type: string
                  parts_checked:
                    type: integer
