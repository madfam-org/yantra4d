#!/usr/bin/env bash

# Yantra4D Cartridge Manager
# Manage madfam-org projects as swappable SDK cartridges.

set -e

PROJECTS_DIR="projects"
ORG="madfam-org"

function print_usage() {
    echo "Yantra4D Cartridge Manager"
    echo ""
    echo "Usage:"
    echo "  tools/cartridge install <repo_name>   # Install a madfam-org project as a cartridge"
    echo "  tools/cartridge remove <repo_name>    # Safely remove a cartridge"
    echo "  tools/cartridge sync                  # Sync all installed cartridges to latest upstream"
    echo ""
}

function install_cartridge() {
    local repo_name="$1"
    if [ -z "$repo_name" ]; then
        echo "Error: Need a repository name (e.g. custom-msh)"
        exit 1
    fi

    local target_path="$PROJECTS_DIR/$repo_name"
    local repo_url="https://github.com/$ORG/$repo_name.git"

    if [ -d "$target_path" ]; then
        echo "Cartridge '$repo_name' is already installed."
        exit 0
    fi

    echo "Installing Cartridge SDK: $repo_name..."
    git submodule add "$repo_url" "$target_path"
    git submodule update --init "$target_path"

    echo "Successfully slotted in '$repo_name' cartridge!"
}

function remove_cartridge() {
    local repo_name="$1"
    if [ -z "$repo_name" ]; then
        echo "Error: Need a repository name (e.g. custom-msh)"
        exit 1
    fi

    local target_path="$PROJECTS_DIR/$repo_name"

    if [ ! -d "$target_path" ]; then
        echo "Error: Cartridge '$repo_name' not found."
        exit 1
    fi

    echo "Removing Cartridge SDK: $repo_name..."
    # Deinitialize the submodule
    git submodule deinit -f "$target_path" || true
    # Remove it from the working tree
    git rm -f "$target_path" || true
    # Clean up the .git directory reference
    rm -rf ".git/modules/$target_path" || true

    echo "Successfully removed '$repo_name' cartridge."
}

function sync_cartridges() {
    echo "Syncing all active Hyperobject SDK cartridges..."
    git submodule update --remote --merge "$PROJECTS_DIR"/*
    echo "Sync complete."
}

COMMAND="$1"

case "$COMMAND" in
    install)
        install_cartridge "$2"
        ;;
    remove)
        remove_cartridge "$2"
        ;;
    sync)
        sync_cartridges
        ;;
    *)
        print_usage
        exit 1
        ;;
esac
