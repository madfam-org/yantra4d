{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://4d.madfam.io/schemas/project-manifest.schema.json",
  "title": "Yantra4D Project Manifest",
  "description": "Schema for project.json files used by the Yantra4D parametric 3D design platform.",
  "type": "object",
  "required": [
    "project",
    "modes",
    "parts",
    "parameters",
    "estimate_constants"
  ],
  "properties": {
    "project": {
      "type": "object",
      "required": [
        "name",
        "slug",
        "version"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable project name"
        },
        "slug": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9-_]*$",
          "description": "URL-safe project identifier"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "description": {
          "$ref": "#/$defs/i18nString"
        },
        "thumbnail": {
          "$ref": "#/$defs/i18nString",
          "description": "Relative path to project thumbnail image"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Searchable tags for project gallery"
        },
        "difficulty": {
          "type": "string",
          "enum": [
            "beginner",
            "intermediate",
            "advanced"
          ],
          "description": "Project complexity level"
        }
      }
    },
    "modes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "scad_file",
          "label",
          "parts",
          "estimate"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "slug": {
            "type": "string"
          },
          "scad_file": {
            "type": "string",
            "pattern": "\\.scad$"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "parts": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "minItems": 1
          },
          "estimate": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "properties": {
                  "base_time": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "base_units": {
                    "type": [
                      "integer",
                      "number",
                      "string"
                    ]
                  },
                  "per_unit": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "per_part": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "fn_factor": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "wasm_multiplier": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "warning_threshold_seconds": {
                    "type": [
                      "integer",
                      "number"
                    ]
                  },
                  "formula": {
                    "type": "string"
                  },
                  "formula_vars": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "additionalProperties": true
              }
            ]
          }
        },
        "additionalProperties": true
      }
    },
    "parameters": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "type",
          "label"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "slider",
              "checkbox",
              "text",
              "select"
            ]
          },
          "default": {},
          "min": {
            "type": "number"
          },
          "max": {
            "type": "number"
          },
          "step": {
            "type": "number"
          },
          "maxlength": {
            "type": "number"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "tooltip": {
            "$ref": "#/$defs/i18nString"
          },
          "group": {
            "type": "string"
          },
          "modes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "visible_in_modes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "advanced": {
            "type": "boolean"
          },
          "parent": {
            "type": "string"
          },
          "visibility_level": {
            "type": "string"
          },
          "disabled": {
            "type": "boolean"
          },
          "widget": {
            "type": "object",
            "description": "Custom widget plugin for this parameter.",
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "custom",
                  "color-gradient",
                  "pattern-selector",
                  "image-picker"
                ]
              },
              "url": {
                "type": "string",
                "description": "URL of ES module exporting a React component (for type=custom)"
              }
            },
            "required": [
              "type"
            ]
          }
        },
        "anyOf": [
          {
            "required": [
              "id"
            ]
          },
          {
            "required": [
              "name"
            ]
          }
        ]
      }
    },
    "grid_presets": {
      "type": "object",
      "properties": {
        "active": {
          "type": "string"
        },
        "default": {
          "type": "string"
        }
      },
      "additionalProperties": {
        "type": "object",
        "required": [
          "label",
          "values"
        ],
        "properties": {
          "emoji": {
            "type": "string"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "values": {
            "type": "object"
          }
        }
      }
    },
    "presets": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "label",
          "values"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "slug": {
            "type": "string"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "values": {
            "type": "object"
          }
        }
      }
    },
    "camera_views": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "id",
          "label",
          "position"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "position": {
            "type": "array",
            "items": {
              "type": "number"
            },
            "minItems": 3,
            "maxItems": 3
          }
        }
      }
    },
    "parameter_groups": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "label"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "key": {
            "type": "string"
          },
          "slug": {
            "type": "string"
          },
          "label": {
            "$ref": "#/$defs/i18nString"
          },
          "levels": {
            "type": "array",
            "items": {
              "oneOf": [
                {
                  "type": "string"
                },
                {
                  "type": "object",
                  "required": [
                    "id",
                    "label"
                  ],
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "label": {
                      "$ref": "#/$defs/i18nString"
                    }
                  }
                }
              ]
            }
          }
        },
        "anyOf": [
          {
            "required": [
              "id"
            ]
          },
          {
            "required": [
              "key"
            ]
          },
          {
            "required": [
              "slug"
            ]
          }
        ]
      }
    },
    "viewer": {
      "type": "object",
      "properties": {
        "default_color": {
          "type": "string"
        }
      }
    },
    "verification": {
      "type": "object",
      "properties": {
        "stages": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "checks": {
                "type": "object",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "enabled": {
                      "type": "boolean"
                    },
                    "expected": {},
                    "xy_tolerance_mm": {
                      "type": "number"
                    },
                    "z_ratio_min": {
                      "type": "number"
                    },
                    "z_ratio_max": {
                      "type": "number"
                    },
                    "min_facets": {
                      "type": "integer"
                    },
                    "min_thickness_mm": {
                      "type": "number"
                    },
                    "max_angle_deg": {
                      "type": "number"
                    },
                    "min_size_mm": {
                      "type": "number"
                    }
                  },
                  "additionalProperties": true
                }
              }
            },
            "required": [
              "checks"
            ]
          }
        },
        "mode_overrides": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "stages": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "overrides": {
                "type": "object",
                "additionalProperties": true
              },
              "part_overrides": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        }
      },
      "required": [
        "stages"
      ]
    },
    "export_formats": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "stl",
          "3mf",
          "off"
        ]
      },
      "default": [
        "stl"
      ],
      "description": "Supported export formats. OpenSCAD determines format from file extension."
    },
    "print_estimation": {
      "type": "object",
      "description": "Print estimation configuration for slicer heuristics.",
      "properties": {
        "default_material": {
          "type": "string",
          "enum": [
            "pla",
            "petg",
            "abs",
            "tpu"
          ],
          "default": "pla"
        },
        "default_infill": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.2
        },
        "material_profiles": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "access_control": {
      "type": "object",
      "description": "Per-project access control. Missing = fully public.",
      "properties": {
        "view": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "configure": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "download_stl": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "download_scad": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "render": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "download": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        },
        "export": {
          "enum": [
            "public",
            "authenticated"
          ],
          "default": "public"
        }
      },
      "additionalProperties": false
    },
    "bom": {
      "oneOf": [
        {
          "type": "object",
          "description": "Bill of materials configuration.",
          "properties": {
            "hardware": {
              "type": "array",
              "items": {
                "type": "object",
                "required": [
                  "id",
                  "label",
                  "quantity_formula"
                ],
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "label": {
                    "$ref": "#/$defs/i18nString"
                  },
                  "quantity_formula": {
                    "type": [
                      "string",
                      "number"
                    ]
                  },
                  "unit": {
                    "type": "string"
                  },
                  "supplier_url": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        {
          "type": "array",
          "description": "Legacy BOM array format (e.g. Ultimate Box).",
          "items": {
            "type": "object",
            "required": [
              "item",
              "qty",
              "condition"
            ],
            "properties": {
              "item": {
                "$ref": "#/$defs/i18nString"
              },
              "qty": {
                "type": "number"
              },
              "condition": {
                "type": "string"
              }
            }
          }
        },
        {
          "type": "array",
          "description": "Legacy BOM array format with quantity_formula (e.g. Yapp Box).",
          "items": {
            "type": "object",
            "required": [
              "item",
              "quantity_formula"
            ],
            "properties": {
              "item": {
                "$ref": "#/$defs/i18nString"
              },
              "quantity_formula": {
                "type": [
                  "string",
                  "number"
                ]
              },
              "conditional": {
                "$ref": "#/$defs/i18nString"
              }
            }
          }
        }
      ]
    },
    "assembly_steps": {
      "type": "array",
      "description": "Step-by-step assembly instructions.",
      "items": {
        "oneOf": [
          {
            "$ref": "#/$defs/i18nString"
          },
          {
            "type": "object",
            "required": [
              "step",
              "label"
            ],
            "properties": {
              "step": {
                "type": "integer",
                "minimum": 1
              },
              "label": {
                "$ref": "#/$defs/i18nString"
              },
              "highlight_parts": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "visible_parts": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "camera": {
                "type": "array",
                "items": {
                  "type": "number"
                },
                "minItems": 3,
                "maxItems": 3
              },
              "camera_target": {
                "type": "array",
                "items": {
                  "type": "number"
                },
                "minItems": 3,
                "maxItems": 3
              },
              "notes": {
                "$ref": "#/$defs/i18nString"
              },
              "hardware": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          }
        ]
      }
    },
    "constraints": {
      "type": "array",
      "description": "Cross-parameter validation rules evaluated client-side via expr-eval.",
      "items": {},
      "anyOf": [
        {
          "required": [
            "rule",
            "message"
          ]
        },
        {
          "required": [
            "expression",
            "message"
          ]
        }
      ]
    }
  },
  "materials": {
    "type": "array",
    "description": "Custom material profiles for print estimation. Falls back to built-in profiles if absent.",
    "items": {
      "type": "object",
      "required": [
        "id",
        "name",
        "density",
        "cost_per_kg"
      ],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "density": {
          "type": "number",
          "description": "g/cmÂ³"
        },
        "cost_per_kg": {
          "type": "number"
        },
        "print_speed_factor": {
          "type": "number",
          "default": 1.0,
          "description": "Multiplier vs PLA baseline speed"
        }
      }
    }
  },
  "source": {
    "type": "object",
    "description": "Import source metadata (e.g., GitHub repo origin).",
    "properties": {
      "type": {
        "type": "string",
        "enum": [
          "github",
          "upload",
          "local"
        ]
      },
      "repo_url": {
        "type": "string",
        "format": "uri"
      },
      "imported_at": {
        "type": "string",
        "format": "date-time"
      }
    }
  },
  "estimate_constants": {
    "type": "object",
    "required": [
      "base_time",
      "per_unit",
      "per_part"
    ],
    "properties": {
      "base_time": {
        "type": "number"
      },
      "per_unit": {
        "type": "number"
      },
      "per_part": {
        "type": "number"
      },
      "fn_factor": {
        "type": "number"
      },
      "wasm_multiplier": {
        "type": "number"
      },
      "warning_threshold_seconds": {
        "type": "number"
      }
    }
  },
  "$defs": {
    "i18nString": {
      "oneOf": [
        {
          "type": "string"
        },
        {
          "type": "object",
          "properties": {
            "en": {
              "type": "string"
            },
            "es": {
              "type": "string"
            }
          },
          "required": [
            "en"
          ]
        }
      ]
    }
  }
}