{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://qubic.madfam.io/schemas/project-manifest.schema.json",
  "title": "Qubic Project Manifest",
  "description": "Schema for project.json files used by the Qubic parametric 3D design platform.",
  "type": "object",
  "required": ["project", "modes", "parts", "parameters", "estimate_constants"],
  "properties": {
    "project": {
      "type": "object",
      "required": ["name", "slug", "version"],
      "properties": {
        "name": { "type": "string", "description": "Human-readable project name" },
        "slug": { "type": "string", "pattern": "^[a-z0-9][a-z0-9-_]*$", "description": "URL-safe project identifier" },
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "description": { "type": "string" },
        "thumbnail": { "type": "string", "description": "Relative path to project thumbnail image" },
        "tags": { "type": "array", "items": { "type": "string" }, "description": "Searchable tags for project gallery" },
        "difficulty": { "type": "string", "enum": ["beginner", "intermediate", "advanced"], "description": "Project complexity level" }
      }
    },
    "modes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "scad_file", "label", "parts", "estimate"],
        "properties": {
          "id": { "type": "string" },
          "scad_file": { "type": "string", "pattern": "\\.scad$" },
          "label": { "$ref": "#/$defs/i18nString" },
          "parts": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
          "estimate": {
            "type": "object",
            "properties": {
              "base_units": { "type": ["integer", "number", "string"] },
              "formula": { "type": "string", "enum": ["constant", "grid"] },
              "formula_vars": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "parts": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "render_mode", "label", "default_color"],
        "properties": {
          "id": { "type": "string" },
          "render_mode": { "type": "integer", "minimum": 0 },
          "label": { "$ref": "#/$defs/i18nString" },
          "default_color": { "type": "string", "pattern": "^#[0-9a-fA-F]{6}$" }
        }
      }
    },
    "parameters": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "type", "default", "label"],
        "properties": {
          "id": { "type": "string" },
          "type": { "type": "string", "enum": ["slider", "checkbox", "text"] },
          "default": {},
          "min": { "type": "number" },
          "max": { "type": "number" },
          "step": { "type": "number" },
          "label": { "$ref": "#/$defs/i18nString" },
          "tooltip": { "$ref": "#/$defs/i18nString" },
          "group": { "type": "string" },
          "visible_in_modes": { "type": "array", "items": { "type": "string" } },
          "visibility_level": { "type": "string" },
          "parent": { "type": "string" },
          "disabled": { "type": "boolean" },
          "widget": {
            "type": "object",
            "description": "Custom widget plugin for this parameter.",
            "properties": {
              "type": { "type": "string", "enum": ["custom", "color-gradient", "pattern-selector", "image-picker"] },
              "url": { "type": "string", "description": "URL of ES module exporting a React component (for type=custom)" }
            },
            "required": ["type"]
          }
        }
      }
    },
    "presets": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "label", "values"],
        "properties": {
          "id": { "type": "string" },
          "label": { "$ref": "#/$defs/i18nString" },
          "values": { "type": "object" }
        }
      }
    },
    "camera_views": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "label", "position"],
        "properties": {
          "id": { "type": "string" },
          "label": { "$ref": "#/$defs/i18nString" },
          "position": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 }
        }
      }
    },
    "parameter_groups": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "label"],
        "properties": {
          "id": { "type": "string" },
          "label": { "$ref": "#/$defs/i18nString" },
          "levels": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "viewer": {
      "type": "object",
      "properties": {
        "default_color": { "type": "string" }
      }
    },
    "verification": {
      "type": "object",
      "properties": {
        "stages": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "checks": {
                "type": "object",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "enabled": { "type": "boolean" }
                  },
                  "additionalProperties": true
                }
              }
            },
            "required": ["checks"]
          }
        },
        "mode_overrides": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "stages": { "type": "array", "items": { "type": "string" } },
              "overrides": { "type": "object", "additionalProperties": true },
              "part_overrides": { "type": "object", "additionalProperties": true }
            }
          }
        }
      },
      "required": ["stages"]
    },
    "export_formats": {
      "type": "array",
      "items": { "type": "string", "enum": ["stl", "3mf", "off"] },
      "default": ["stl"],
      "description": "Supported export formats. OpenSCAD determines format from file extension."
    },
    "print_estimation": {
      "type": "object",
      "description": "Print estimation configuration for slicer heuristics.",
      "properties": {
        "default_material": { "type": "string", "enum": ["pla", "petg", "abs", "tpu"], "default": "pla" },
        "default_infill": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.2 }
      }
    },
    "access_control": {
      "type": "object",
      "description": "Per-project access control. Missing = fully public.",
      "properties": {
        "view": { "enum": ["public", "authenticated"], "default": "public" },
        "configure": { "enum": ["public", "authenticated"], "default": "public" },
        "download_stl": { "enum": ["public", "authenticated"], "default": "public" },
        "download_scad": { "enum": ["public", "authenticated"], "default": "public" }
      },
      "additionalProperties": false
    },
    "bom": {
      "type": "object",
      "description": "Bill of materials configuration.",
      "properties": {
        "hardware": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "label", "quantity_formula"],
            "properties": {
              "id": { "type": "string" },
              "label": { "$ref": "#/$defs/i18nString" },
              "quantity_formula": { "type": ["string", "number"], "description": "Expression using param IDs or a constant number" },
              "unit": { "type": "string", "default": "pcs" },
              "supplier_url": { "type": "string", "format": "uri" }
            }
          }
        }
      }
    },
    "assembly_steps": {
      "type": "array",
      "description": "Step-by-step assembly instructions.",
      "items": {
        "type": "object",
        "required": ["step", "label"],
        "properties": {
          "step": { "type": "integer", "minimum": 1 },
          "label": { "$ref": "#/$defs/i18nString" },
          "highlight_parts": { "type": "array", "items": { "type": "string" } },
          "camera": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 },
          "notes": { "$ref": "#/$defs/i18nString" }
        }
      }
    },
    "constraints": {
      "type": "array",
      "description": "Cross-parameter validation rules evaluated client-side via expr-eval.",
      "items": {
        "type": "object",
        "required": ["rule", "message", "severity"],
        "properties": {
          "rule": { "type": "string", "description": "Expression using parameter IDs. Must return truthy when valid." },
          "message": { "$ref": "#/$defs/i18nString" },
          "severity": { "type": "string", "enum": ["error", "warning"] },
          "applies_to": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Parameter IDs this constraint visually attaches to."
          }
        }
      }
    },
    "materials": {
      "type": "array",
      "description": "Custom material profiles for print estimation. Falls back to built-in profiles if absent.",
      "items": {
        "type": "object",
        "required": ["id", "name", "density", "cost_per_kg"],
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "density": { "type": "number", "description": "g/cmÂ³" },
          "cost_per_kg": { "type": "number" },
          "print_speed_factor": { "type": "number", "default": 1.0, "description": "Multiplier vs PLA baseline speed" }
        }
      }
    },
    "grid_presets": { "type": "object", "additionalProperties": { "type": "object" } },
    "estimate_constants": {
      "type": "object",
      "required": ["base_time", "per_unit", "per_part"],
      "properties": {
        "base_time": { "type": "number" },
        "per_unit": { "type": "number" },
        "per_part": { "type": "number" },
        "fn_factor": { "type": "number" },
        "wasm_multiplier": { "type": "number" },
        "warning_threshold_seconds": { "type": "number" }
      }
    }
  },
  "$defs": {
    "i18nString": {
      "oneOf": [
        { "type": "string" },
        { "type": "object", "properties": { "en": { "type": "string" }, "es": { "type": "string" } }, "required": ["en"] }
      ]
    }
  }
}
